<!DOCTYPE html>
<html>
  <head>
    <title>MeotoLog</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    <!-- ã‚¹ãƒãƒ›ç”¨ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆApple Touch Iconï¼‰ -->
    <!-- hrefã«ã¯ç”»åƒã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¾ã™ã€‚ä»Šå›ã¯ä»®ã§ã€Œã„ã‚‰ã™ã¨ã‚„ã€ã®ãƒãƒ¼ãƒˆã®ç”»åƒã«ã—ã¦ã„ã¾ã™ -->
    <link rel="apple-touch-icon" href="https://1.bp.blogspot.com/-D2WfK-PrJ94/X6tl8yC5QII/AAAAAAABcTU/jF1Zyk6K9r0tLzYlDdyJOtC4LqMKYT6gQCnBGAsYHQ/s180/heart_mark.png">
  
    <!-- â–¼ ã¤ã„ã§ã«ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ãƒ–ç”¨ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆFaviconï¼‰ã‚‚è¨­å®š -->
    <link rel="icon" href="https://1.bp.blogspot.com/-D2WfK-PrJ94/X6tl8yC5QII/AAAAAAABcTU/jF1Zyk6K9r0tLzYlDdyJOtC4LqMKYT6gQCnBGAsYHQ/s180/heart_mark.png">

  </head>

  <body class="bg-gray-50 text-gray-800 font-sans">
    
    <!-- â–¼ ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
      <div class="w-full max-w-6xl mx-auto px-4 h-14 flex justify-between items-center">
        <!-- ãƒ­ã‚´ -->
        <%= link_to root_path, class: "font-bold text-xl text-indigo-600 tracking-tight" do %>
          Meoto-Log
        <% end %>

        <!-- å³å´ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã§åˆ‡ã‚Šæ›¿ãˆï¼‰ -->
        <div class="text-sm">
          <% if user_signed_in? %>
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†ã¸ï¼‰ -->
        <%= link_to edit_user_registration_path, class: "flex items-center gap-2 text-gray-600 hover:text-indigo-600 font-bold transition" do %>
          <!-- äººã‚¢ã‚¤ã‚³ãƒ³ -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
          </svg>
          <%= current_user.nickname %>
        <% end %>
        
            <%= link_to "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ", destroy_user_session_path, data: { turbo_method: :delete }, class: "text-gray-500 hover:text-gray-700" %>
          <% else %>
            <!-- æœªãƒ­ã‚°ã‚¤ãƒ³ï¼šãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
            <%= link_to "ãƒ­ã‚°ã‚¤ãƒ³", new_user_session_path, class: "text-indigo-600 font-bold mr-3" %>
            <%= link_to "æ–°è¦ç™»éŒ²", new_user_registration_path, class: "bg-indigo-600 text-white px-3 py-1.5 rounded-full text-xs font-bold hover:bg-indigo-700" %>
          <% end %>
        </div>
      </div>
    </header>

    <!-- â–¼ ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆé€šçŸ¥ï¼‰ -->
    <% if notice %>
      <p class="bg-blue-50 text-blue-700 px-4 py-2 text-sm text-center"><%= notice %></p>
    <% end %>
    <% if alert %>
      <p class="bg-red-50 text-red-700 px-4 py-2 text-sm text-center"><%= alert %></p>
    <% end %>

    <!-- â–¼ ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="pb-20"> <!-- ãƒœãƒˆãƒ ãƒŠãƒ“ã®åˆ†ã ã‘ä¸‹ã«ä½™ç™½ -->
      <%= yield %>
    </main>

    <!-- â–¼ ã‚¹ãƒãƒ›ç”¨ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
    <% if user_signed_in? %>
      <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around items-center py-2 z-40 pb-safe">
        
        <!-- ãƒ›ãƒ¼ãƒ  -->
        <%= link_to root_path, class: "flex flex-col items-center w-full py-1 text-gray-400 hover:text-indigo-600 transition #{current_page?(root_path) ? 'text-indigo-600' : ''}" do %>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mb-0.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
          </svg>
          <span class="text-[10px] font-bold">ãƒ›ãƒ¼ãƒ </span>
        <% end %>

        <!-- ç›¸è«‡ã™ã‚‹ï¼ˆçœŸã‚“ä¸­ã®ç›®ç«‹ã¤ãƒœã‚¿ãƒ³ï¼‰ -->
       <%= link_to "#", onclick: "if(window.openModal){window.openModal();return false;} else {window.location.href='/'}", class: "flex flex-col items-center w-full relative group z-50" do %>
  <div class="bg-indigo-600 text-white rounded-full p-3 absolute -top-6 border-4 border-white shadow-lg group-hover:bg-indigo-700 transition">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
            </svg>
          </div>
          <span class="text-[10px] font-bold text-indigo-600 mt-9">ç›¸è«‡</span>
        <% end %>

        <!-- ç›¸è«‡ãƒ­ã‚° -->
        <%= link_to consultations_path, class: "flex flex-col items-center w-full py-1 text-gray-400 hover:text-indigo-600 transition #{current_page?(consultations_path) ? 'text-indigo-600' : ''}" do %>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mb-0.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
          </svg>
          <span class="text-[10px] font-bold">ç›¸è«‡ãƒ­ã‚°</span>
        <% end %>

      </nav>

      <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç›¸è«‡ç”»é¢ï¼‰ -->
    <div id="modal" class="fixed inset-0 bg-black/60 z-[100] hidden justify-center items-end backdrop-blur-sm" onclick="closeModal(event)">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-3xl p-6 shadow-2xl transform transition-transform" onclick="event.stopPropagation()">
            <!-- ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ -->
            <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6"></div>
            
            <h3 class="text-lg font-bold text-gray-800 mb-1">AIã«ç›¸è«‡ã™ã‚‹</h3>
            <p class="text-xs text-gray-500 mb-6">çŠ¶æ³ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€AIãŒæœ€é©ãªè¨€è‘‰ã‚’è¿”ã—ã¾ã™</p>
            
            <div class="flex gap-2 mb-4">
                <input type="text" id="userInput" placeholder="ä¾‹ï¼šã€ã”é£¯ã¾ã ï¼Ÿã€ã¨èã„ãŸã‚‰æ€’ã‚‰ã‚ŒãŸ..." class="flex-1 bg-gray-50 border-0 rounded-full px-5 py-4 focus:ring-2 focus:ring-blue-500 font-medium text-gray-800 placeholder-gray-400">
                <button class="send-btn bg-blue-600 text-white font-bold px-6 rounded-full hover:bg-blue-700 transition shadow-lg shadow-blue-200" onclick="simulateAI()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>

            <!-- AIã®è¿”ä¿¡è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="ai-response hidden mt-4" id="aiResponse">
                <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                    <div class="ai-score font-bold mb-3 text-lg"></div>
                    <p class="text-sm text-gray-700 leading-relaxed"></p>
                </div>
            </div>
            
            <!-- ä¸‹éƒ¨ã®ä½™ç™½ç¢ºä¿ï¼ˆiPhoneãªã©ã®ãƒãƒ¼ç”¨ï¼‰ -->
            <div class="h-8"></div>
        </div>
    </div>

    <script>
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        window.openModal = function() { 
            const modal = document.getElementById('modal');
            if (!modal) return;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('aiResponse').classList.add('hidden'); 
            document.getElementById('userInput').value = ''; 
            // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            setTimeout(() => document.getElementById('userInput').focus(), 100);
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal(event) {
            if (event.target === document.getElementById('modal')) {
                const modal = document.getElementById('modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        // AIç›¸è«‡å‡¦ç†
        function simulateAI() {
            const input = document.getElementById('userInput').value;
            if (!input) return alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            const sendBtn = document.querySelector('.send-btn');
            const originalContent = sendBtn.innerHTML;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>';
            
            fetch('/consultations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                },
                body: JSON.stringify({ content: input })
            })
            .then(response => response.json())
            .then(data => {
                const responseArea = document.getElementById('aiResponse');
                const scoreArea = responseArea.querySelector('.ai-score');
                const textArea = responseArea.querySelector('p');

                // 1. ç‚¹æ•°ã«å¿œã˜ã¦ã€Œè‰²ã€ã‚’æ±ºã‚ã‚‹
                let scoreColor = 'text-red-500'; 
                if (data.risk_score >= 80) {
                    scoreColor = 'text-blue-600'; 
                } else if (data.risk_score >= 40) {
                    scoreColor = 'text-yellow-500'; 
                }

                // 2. ã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
                scoreArea.className = `ai-score font-bold ${scoreColor} mb-2`;
                scoreArea.innerText = `äºˆæƒ³ã•ã‚Œã‚‹ã”æ©Ÿå«Œåº¦ï¼š${data.risk_score}ç‚¹`;
                
                textArea.innerHTML = `
                    <div class="mb-3">
                        <span class="bg-white text-gray-500 text-xs font-bold px-2 py-1 rounded border border-gray-200">ğŸ’¡ ã‚¢ãƒ‰ãƒã‚¤ã‚¹</span>
                        <div class="mt-1">${data.advice}</div>
                    </div>
                    <div>
                        <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">ğŸ—£ è§£ç­”ä¾‹</span>
                        <div class="mt-1 font-bold text-gray-800">"${data.ai_response}"</div>
                    </div>
                `;

                responseArea.classList.remove('hidden');
            })
            .catch(error => {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                console.error(error);
            })
            .finally(() => {
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalContent;
            });
        }
    </script>
    <% end %>

  </body>
</html>
