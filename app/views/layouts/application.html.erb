<!DOCTYPE html>
<html>
  <head>
    <title>MeotoLog</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    <!-- ã‚¹ãƒãƒ›ç”¨ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆApple Touch Iconï¼‰ -->
    <!-- hrefã«ã¯ç”»åƒã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¾ã™ã€‚ä»Šå›ã¯ä»®ã§ã€Œã„ã‚‰ã™ã¨ã‚„ã€ã®ãƒãƒ¼ãƒˆã®ç”»åƒã«ã—ã¦ã„ã¾ã™ -->
    <link rel="icon" href="/penguin.png" type="image/png">
    <link rel="apple-touch-icon" href="/penguin.png">
  </head>

  <body class="bg-gray-50 text-gray-800 font-sans">
    
    <!-- â–¼ ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
      <div class="w-full max-w-6xl mx-auto px-4 h-14 flex justify-between items-center">
        <!-- ãƒ­ã‚´ -->
        <%= link_to root_path, class: "font-bold text-xl text-indigo-600 tracking-tight" do %>
          Meoto-Log
        <% end %>

        <!-- å³å´ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã§åˆ‡ã‚Šæ›¿ãˆï¼‰ -->
        <div class="flex items-center gap-1"> <!-- gapã‚’å°‘ã—ç‹­ã‚ã¦ä¸€ä½“æ„Ÿã‚’å‡ºã™ -->
          <% if user_signed_in? %>
            
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ï¼‰ -->
            <!-- p-2 ã‚’è¿½åŠ ã—ã¦ã‚¿ãƒƒãƒ—é ˜åŸŸã‚’åºƒã’ã¦ã„ã¾ã™ -->
            <%= link_to edit_user_registration_path, class: "flex items-center gap-1 text-gray-600 hover:text-indigo-600 font-bold transition p-2 rounded-lg hover:bg-gray-50 mr-1" do %>
              <!-- ã‚¢ã‚¤ã‚³ãƒ³ -->
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
              </svg>
              <!-- åå‰ï¼ˆé•·ã™ãã‚‹å ´åˆã¯ ... ã§çœç•¥ã™ã‚‹è¨­å®šã‚’è¿½åŠ ï¼‰ -->
              <span class="text-sm max-w-[8rem] truncate"><%= current_user.nickname %></span>
            <% end %>

            <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ -->
            <%= link_to "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ", destroy_user_session_path, class: "text-xs text-gray-400 hover:text-red-500 border border-gray-200 px-3 py-1.5 rounded whitespace-nowrap transition" %>
          <% else %>
          
            <!-- æœªãƒ­ã‚°ã‚¤ãƒ³ï¼šãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
            <%= link_to "ãƒ­ã‚°ã‚¤ãƒ³", new_user_session_path, class: "text-indigo-600 font-bold mr-3" %>
            <%= link_to "æ–°è¦ç™»éŒ²", new_user_registration_path, class: "bg-indigo-600 text-white px-3 py-1.5 rounded-full text-xs font-bold hover:bg-indigo-700" %>
          <% end %>
        </div>
      </div>
    </header>

    <!-- â–¼ ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆé€šçŸ¥ï¼‰ -->
   <div class="fixed top-16 left-0 right-0 z-50 flex flex-col items-center gap-2 pointer-events-none">
      <% flash.each do |key, value| %>
        <% 
          # è‰²ã®ãƒ‡ã‚¶ã‚¤ãƒ³ï¼šnoticeãªã‚‰é’ã€alertãªã‚‰èµ¤
          color_class = key == 'notice' ? 'bg-blue-500 text-white' : 'bg-red-500 text-white'
        %>
        <div data-controller="flash" 
             class="<%= color_class %> px-6 py-3 rounded-full shadow-lg text-sm font-bold transition-opacity duration-1000 opacity-100 pointer-events-auto">
          <%= value %>
        </div>
      <% end %>
    </div>

    <!-- â–¼ ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="pb-20"> <!-- ãƒœãƒˆãƒ ãƒŠãƒ“ã®åˆ†ã ã‘ä¸‹ã«ä½™ç™½ -->
      <%= yield %>
    </main>

    <!-- â–¼ ã‚¹ãƒãƒ›ç”¨ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
    <% if user_signed_in? %>
      <nav class="fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around items-center py-2 z-40 pb-safe">
        
        <!-- ãƒ›ãƒ¼ãƒ  -->
        <%= link_to root_path, class: "flex flex-col items-center w-full py-1 text-gray-400 hover:text-indigo-600 transition #{current_page?(root_path) ? 'text-indigo-600' : ''}" do %>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mb-0.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
          </svg>
          <span class="text-[10px] font-bold">ãƒ›ãƒ¼ãƒ </span>
        <% end %>

        <!-- ç›¸è«‡ã™ã‚‹ï¼ˆçœŸã‚“ä¸­ã®ç›®ç«‹ã¤ãƒœã‚¿ãƒ³ï¼‰ -->
       <%= link_to "#", onclick: "if(window.openModal){window.openModal();return false;} else {window.location.href='/'}", class: "flex flex-col items-center w-full relative group z-50" do %>
  <div class="bg-indigo-600 text-white rounded-full p-3 absolute -top-6 border-4 border-white shadow-lg group-hover:bg-indigo-700 transition">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
            </svg>
          </div>
          <span class="text-[10px] font-bold text-indigo-600 mt-9">ç›¸è«‡</span>
        <% end %>

        <!-- ç›¸è«‡ãƒ­ã‚° -->
        <%= link_to consultations_path, class: "flex flex-col items-center w-full py-1 text-gray-400 hover:text-indigo-600 transition #{current_page?(consultations_path) ? 'text-indigo-600' : ''}" do %>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mb-0.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
          </svg>
          <span class="text-[10px] font-bold">ç›¸è«‡ãƒ­ã‚°</span>
        <% end %>

      </nav>

      <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç›¸è«‡ç”»é¢ï¼‰ -->
    <div id="modal" class="fixed inset-0 bg-black/60 z-[100] hidden justify-center items-end backdrop-blur-sm" onclick="closeModal(event)">
        <div class="bg-white w-full max-w-md mx-auto rounded-t-3xl p-6 shadow-2xl transform transition-transform" onclick="event.stopPropagation()">
            <!-- ãƒãƒ³ãƒ‰ãƒ«ãƒãƒ¼ -->
            <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6"></div>
            
            <h3 class="text-lg font-bold text-gray-800 mb-1">ğŸ¦‰ãƒ•ã‚¯ãƒ­ã‚¦ã«ç›¸è«‡ã™ã‚‹</h3>
            <p class="text-xs text-gray-500 mb-6">çŠ¶æ³ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãƒ•ã‚¯ãƒ­ã‚¦ãŒæœ€é©ãªè¨€è‘‰ã‚’è¿”ã—ã¾ã™</p>
            
            <div class="flex gap-2 mb-4 items-end">
                <!-- textareaã«å¤‰æ›´ã€‚rows="1"ã§åˆæœŸã¯1è¡Œã€‚resize-noneã§æ‰‹å‹•ãƒªã‚µã‚¤ã‚ºç¦æ­¢ -->
                <textarea id="userInput" rows="1" class="flex-1 bg-gray-50 border-0 rounded-2xl px-5 py-3 focus:ring-2 focus:ring-blue-500 font-medium text-gray-800 placeholder-gray-400 resize-none overflow-hidden min-h-[50px] max-h-[150px]" oninput="autoResize(this)"></textarea>
                
                <button class="send-btn bg-blue-600 text-white font-bold px-4 py-3 rounded-2xl hover:bg-blue-700 transition shadow-lg shadow-blue-200 h-[50px] flex items-center justify-center" onclick="simulateAI()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>

            <!-- AIã®è¿”ä¿¡è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="ai-response hidden mt-4" id="aiResponse">
                <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                    <div class="ai-score font-bold mb-3 text-lg"></div>
                    <p class="text-sm text-gray-700 leading-relaxed"></p>
                </div>
            </div>
            
            <!-- ä¸‹éƒ¨ã®ä½™ç™½ç¢ºä¿ï¼ˆiPhoneãªã©ã®ãƒãƒ¼ç”¨ï¼‰ -->
            <div class="h-8"></div>
        </div>
    </div>

    <script>
        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’è‡ªå‹•èª¿æ•´ã™ã‚‹é–¢æ•° 
        function autoResize(textarea) {
            textarea.style.height = 'auto'; // ä¸€åº¦ãƒªã‚»ãƒƒãƒˆ
            textarea.style.height = textarea.scrollHeight + 'px'; // æ–‡å­—é‡ã«åˆã‚ã›ã¦é«˜ã•ã‚’è¨­å®š
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        window.openModal = function() { 
            const modal = document.getElementById('modal');
            if (!modal) return;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('aiResponse').classList.add('hidden'); 
            
            const input = document.getElementById('userInput');
            input.value = ''; 
            input.style.height = 'auto'; // é«˜ã•ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
            
            setTimeout(() => document.getElementById('userInput').focus(), 100);
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal(event) {
            if (event.target === document.getElementById('modal')) {
                const modal = document.getElementById('modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        // AIç›¸è«‡å‡¦ç†
        function simulateAI() {
            const input = document.getElementById('userInput').value;
            if (!input) return alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            const sendBtn = document.querySelector('.send-btn');
            const originalContent = sendBtn.innerHTML;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>';
            
            fetch('/consultations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                },
                body: JSON.stringify({ content: input })
            })
            .then(response => response.json())
            .then(data => {
                const responseArea = document.getElementById('aiResponse');
                const scoreArea = responseArea.querySelector('.ai-score');
                const textArea = responseArea.querySelector('p');

                // 1. %ã«å¿œã˜ã¦ã€Œè‰²ã€ã‚’æ±ºã‚ã‚‹
                let scoreColor = 'text-red-500'; 
                if (data.risk_score >= 80) {
                    scoreColor = 'text-blue-600'; 
                } else if (data.risk_score >= 40) {
                    scoreColor = 'text-yellow-500'; 
                }

                // 2. ã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
                scoreArea.className = `ai-score font-bold ${scoreColor} mb-2`;
                scoreArea.innerText = `äºˆæƒ³ã•ã‚Œã‚‹ã”æ©Ÿå«Œåº¦ï¼š${data.risk_score}%`;
                
                textArea.innerHTML = `
                    <div class="mb-3">
                        <span class="bg-white text-gray-500 text-xs font-bold px-2 py-1 rounded border border-gray-200">ğŸ’¡ ã‚¢ãƒ‰ãƒã‚¤ã‚¹</span>
                        <div class="mt-1">${data.advice}</div>
                    </div>
                    <div>
                        <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">ãŠã™ã™ã‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span>
                        <div class="mt-1 font-bold text-gray-800">"${data.ai_response}"</div>
                    </div>
                `;

                responseArea.classList.remove('hidden');

                // â–¼â–¼â–¼ è¿½åŠ ï¼šãƒ›ãƒ¼ãƒ ç”»é¢ã®ã€Œç›´è¿‘ã®ãƒ­ã‚°ã€ã‚‚æ›¸ãæ›ãˆã‚‹å‡¦ç† â–¼â–¼â–¼
                const homeScore = document.getElementById('latest-log-score');
                
                // ã‚‚ã—ãƒ›ãƒ¼ãƒ ç”»é¢ã«ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ãŒã‚ã‚Œã°ï¼ˆIDãŒè¦‹ã¤ã‹ã‚Œã°ï¼‰å®Ÿè¡Œ
                if (homeScore) {
                    // 1. æ—¥ä»˜ã‚’ã€ŒãŸã£ãŸä»Šã€ã«ã™ã‚‹
                    document.getElementById('latest-log-date').innerText = "ãŸã£ãŸä»Š";

                    // 2. å†…å®¹ã¨AIã®è¿”ä¿¡ã‚’æ›´æ–°
                    document.getElementById('latest-log-content').innerText = input; // å…¥åŠ›ã—ãŸç›¸è«‡å†…å®¹
                    document.getElementById('latest-log-response').innerText = data.ai_response;

                    // 3. ã‚¹ã‚³ã‚¢ã®è‰²åˆ¤å®šã¨æ›´æ–°
                    let newColorClass = 'text-red-600 bg-red-50';
                    if (data.risk_score >= 80) {
                        newColorClass = 'text-blue-600 bg-blue-50';
                    } else if (data.risk_score >= 40) {
                        newColorClass = 'text-yellow-600 bg-yellow-50';
                    }
                    
                    // ã‚¯ãƒ©ã‚¹ã‚’å…¨æ›¸ãæ›ãˆã—ã¦è‰²ã‚’æ›´æ–°
                    homeScore.className = `font-bold px-2 py-1 rounded-md ${newColorClass}`;
                    homeScore.innerText = `ã”æ©Ÿå«Œåº¦: ${data.risk_score}%`;
                } else {
                    // ã‚‚ã—ã€Œå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€ã®è¡¨ç¤ºã ã£ãŸå ´åˆã¯ã€
                    // æ§‹é€ ã‚’ä½œã‚‹ã®ãŒå¤§å¤‰ãªã®ã§ã€ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ã‚’è¡¨ç¤ºã•ã›ã‚‹
                    const noLogMsg = document.getElementById('no-log-message');
                    if (noLogMsg) {
                        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚ˆã†ã«ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ç­‰ã®å·¥å¤«ã‚‚ã§ãã¾ã™ãŒ
                        // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ä½•ã‚‚ã—ãªã„ï¼ˆæ¬¡å›ãƒªãƒ­ãƒ¼ãƒ‰ã§åæ˜ ï¼‰ã‹ã€
                        // ã‚ã‚‹ã„ã¯ location.reload() ã—ã¦ã—ã¾ã†æ‰‹ã‚‚ã‚ã‚Šã¾ã™
                    }
                }
                // â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–²

            })
            .catch(error => {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                console.error(error);
            })
            .finally(() => {
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalContent;
            });
        }
    </script>
    <% end %>

  </body>
</html>
